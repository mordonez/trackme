name: PR Cleanup

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    name: Cleanup PR Resources

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Set environment variables
        run: |
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "DB_NAME=trackme-pr-${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "WORKER_NAME=trackme-pr-${{ github.event.pull_request.number }}" >> $GITHUB_ENV

      - name: Delete Cloudflare Secrets
        run: |
          echo "Deleting secrets for worker ${{ env.WORKER_NAME }}..."
          npx wrangler secret delete USER --name ${{ env.WORKER_NAME }} --force || echo "Secret may not exist"
          npx wrangler secret delete PASSWORD --name ${{ env.WORKER_NAME }} --force || echo "Secret may not exist"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Delete Cloudflare Worker
        run: |
          echo "Deleting worker ${{ env.WORKER_NAME }}..."
          npx wrangler delete ${{ env.WORKER_NAME }} --force || echo "Worker may not exist or already deleted"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Delete D1 Database
        run: |
          echo "Deleting database ${{ env.DB_NAME }}..."

          # Get the database ID
          DB_ID=$(npx wrangler d1 list | grep "${{ env.DB_NAME }}" | awk '{print $2}' || echo "")

          if [ -n "$DB_ID" ]; then
            echo "Found database with ID: $DB_ID"
            npx wrangler d1 delete ${{ env.DB_NAME }} --skip-confirmation || echo "Failed to delete database"
          else
            echo "Database not found, may have been already deleted"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const dbName = '${{ env.DB_NAME }}';
            const workerName = '${{ env.WORKER_NAME }}';

            const comment = `## ðŸ§¹ Preview Environment Cleaned Up

            The preview environment for this PR has been deleted:

            **Deleted Resources:**
            - âœ… Worker: \`${workerName}\`
            - âœ… Database: \`${dbName}\`
            - âœ… Secrets: USER, PASSWORD

            All temporary resources have been removed. No credentials or data remain.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
